name: CI

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 6 * * *'

env:
  NAMESPACE: cisco
  COLLECTION_NAME: dnac

jobs:
  sanity:
    name: Sanity (â’¶${{ matrix.ansible }})
    strategy:
      matrix:
        ansible:
          - stable-2.17
          - stable-2.18
          - devel
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ”„ Check out code
        uses: actions/checkout@v3
        with:
          path: cisco-en-programmability/dnacenter-ansible

      - name: ğŸ“ Create collection directory
        run: |
          echo "== Creando estructura de directorios =="
          mkdir -p ./ansible_collections/${{ env.NAMESPACE }}

      - name: ğŸ“¦ Move repository into collection path
        run: |
          echo "== Moviendo el repositorio a la estructura de colecciÃ³n =="
          mv ./cisco-en-programmability/dnacenter-ansible ./ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.11'

      - name: ğŸ“¥ Install Ansible (${{ matrix.ansible }})
        run: |
          echo "== Instalando Ansible desde rama: ${{ matrix.ansible }} =="
          pip install https://github.com/ansible/ansible/archive/${{ matrix.ansible }}.tar.gz --disable-pip-version-check
          echo "== Ansible instalado: $(ansible --version)"

      - name: ğŸ“Š Check memory before sanity tests
        run: |
          echo "== ğŸ“Š Memoria libre antes de los tests =="
          free -h
          echo "== ğŸ§  Procesos con mÃ¡s uso de RAM =="
          ps aux --sort=-%mem | head -n 10

      - name: âœ… Run sanity test import (with limited concurrency)
        run: |
          echo "== ğŸš€ Ejecutando 'sanity test: import' con concurrencia limitada =="
          export ANSIBLE_TEST_SANITY_IMPORT_PYTHON_CONCURRENCY=1
          ansible-test sanity --test import -v --color --docker
          # Si quieres probar sin Docker, comenta la lÃ­nea anterior y descomenta esta:
          # ansible-test sanity --test import -v --color
        working-directory: ./ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}

      - name: ğŸ“Š Check memory after import test
        run: |
          echo "== ğŸ“Š Memoria libre despuÃ©s del test de import =="
          free -h
          echo "== ğŸ§  Procesos con mÃ¡s uso de RAM =="
          ps aux --sort=-%mem | head -n 10

      - name: âœ… Run remaining sanity tests (excluding import)
        run: |
          echo "== ğŸš€ Ejecutando el resto de sanity tests (excluyendo import) =="
          ansible-test sanity --exclude import -v --color --docker
          # Si quieres probar sin Docker, comenta la lÃ­nea anterior y descomenta esta:
          # ansible-test sanity --exclude import -v --color
        working-directory: ./ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}

      - name: ğŸ“Š Check memory after all tests
        run: |
          echo "== ğŸ“Š Memoria libre al final de todos los tests =="
          free -h
          echo "== ğŸ§  Procesos con mÃ¡s uso de RAM =="
          ps aux --sort=-%mem | head -n 10

      - name: ğŸ“ Final summary
        run: |
          echo "== âœ… Pipeline finalizado correctamente para Ansible: ${{ matrix.ansible }} =="
